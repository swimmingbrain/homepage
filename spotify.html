<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Braian's music vibes - Curated playlists and favorite tracks">
    <meta name="keywords" content="music, spotify, playlists, tracks">
    <meta name="author" content="Braian">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://sdk.scdn.co https://api.spotify.com; script-src 'self' https://sdk.scdn.co 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.spotify.com https://accounts.spotify.com; media-src 'self' https://*.spotify.com;">
    <meta http-equiv="Permissions-Policy" content="autoplay=*, encrypted-media=*">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <title>Music Vibes - Braian</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/spotify.css">
    <link rel="preload" href="assets/css/style.css" as="style">
    <link rel="preload" href="assets/css/spotify.css" as="style">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>
    <div class="ocean-bg">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>

    <div class="container">
        <header class="header">
            <div class="welcome-text">
                <h1>my <span class="highlight">music</span> vibes</h1>
                <span class="domain">curated playlists & favorite tracks</span>
            </div>
            <div class="divider"></div>
        </header>

        <div class="spotify-container">
            <div id="login-container" style="display: none;">
                <div class="login-box">
                    <h2>Welcome to Music Vibes</h2>
                    <p>Please login with your Spotify account to continue</p>
                    <button class="login-button" onclick="login()">Login with Spotify</button>
                </div>
            </div>

            <div id="player-container" style="display: none;">
                <div class="playlist-grid" id="playlistGrid">
                    <!-- Playlists will be loaded here dynamically -->
                </div>

                <div class="player-container" id="playerContainer">
                    <div class="now-playing">
                        <div class="track-info">
                            <img id="albumArt" src="" alt="Album Art">
                            <div class="track-details">
                                <h3 id="trackName">Select a track to play</h3>
                                <p id="artistName">-</p>
                            </div>
                        </div>
                        <div class="player-controls">
                            <button id="prevTrack" class="control-btn">‚èÆ</button>
                            <button id="playPause" class="control-btn">‚ñ∂</button>
                            <button id="nextTrack" class="control-btn">‚è≠</button>
                        </div>
                        <div class="progress-bar">
                            <div class="progress" id="progress"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>¬© 2025 SwimmingBrain.dev - Where ideas float and code flow üåä</p>
        </footer>
    </div>

    <script>
        // Spotify Web Playback SDK setup
        let player;
        let token;
        let deviceId;

        // Replace with your Spotify Client ID
        const CLIENT_ID = 'bf45e9aa56e64d4c924c7136bc358631';
        const REDIRECT_URI = 'https://swimmingbrain.dev/spotify.html';
        const USER_ID = 'kg78o2lmqe4af77s3morbt5eq'; // Your Spotify user ID

        // Initialize the Spotify Web Playback SDK
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify SDK Ready');
            if (!token) {
                console.log('No token available, showing login...');
                showLogin();
                return;
            }
            
            initializePlayer();
        };

        function initializePlayer() {
            console.log('Initializing player with token');
            player = new Spotify.Player({
                name: 'SwimmingBrain Player',
                getOAuthToken: cb => { cb(token); },
                volume: 0.5
            });

            // Error handling
            player.addListener('initialization_error', ({ message }) => { 
                console.error('Initialization Error:', message);
                showError('Failed to initialize player. Please try refreshing the page.');
            });
            player.addListener('authentication_error', ({ message }) => { 
                console.error('Authentication Error:', message);
                showError('Authentication failed. Please try logging in again.');
                handleAuthError();
            });
            player.addListener('account_error', ({ message }) => { 
                console.error('Account Error:', message);
                showError('Account error. Please check your Spotify account status.');
            });
            player.addListener('playback_error', ({ message }) => { 
                console.error('Playback Error:', message);
                showError('Playback error. Please try again.');
            });

            // Playback status updates
            player.addListener('player_state_changed', state => {
                if (state) {
                    updatePlayerUI(state);
                }
            });

            // Ready
            player.addListener('ready', ({ device_id }) => {
                deviceId = device_id;
                console.log('Ready with Device ID', device_id);
            });

            // Connect to the player
            player.connect();
        }

        function handleAuthError() {
            console.log('Handling auth error');
            localStorage.removeItem('spotify_token');
            localStorage.removeItem('spotify_auth_state');
            showLogin();
        }

        function showLogin() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('player-container').style.display = 'none';
        }

        function showPlayer() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('player-container').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.spotify-container').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function exchangeCodeForToken(code) {
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + 'YOUR_CLIENT_SECRET')
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to exchange code for token');
                }

                const data = await response.json();
                return data.access_token;
            } catch (error) {
                console.error('Error exchanging code for token:', error);
                throw error;
            }
        }

        function login() {
            const scope = 'user-read-private user-read-email user-read-playback-state user-modify-playback-state user-read-currently-playing playlist-read-private';
            const state = generateRandomString(16);
            localStorage.setItem('spotify_auth_state', state);
            
            const params = new URLSearchParams({
                client_id: CLIENT_ID,
                response_type: 'code',
                redirect_uri: REDIRECT_URI,
                state: state,
                scope: scope,
                show_dialog: true
            });
            
            const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
            console.log('Redirecting to:', authUrl);
            window.location.href = authUrl;
        }

        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let text = '';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        // Check for authentication
        window.onload = async () => {
            console.log('Window loaded, checking authentication...');
            
            // Check for error in URL
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            
            if (error) {
                console.error('Authentication error:', error);
                showError(`Authentication error: ${error}`);
                localStorage.removeItem('spotify_token');
                localStorage.removeItem('spotify_auth_state');
                showLogin();
                return;
            }

            // Check for authorization code
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            // Validate state parameter
            const storedState = localStorage.getItem('spotify_auth_state');
            if (state && state !== storedState) {
                console.error('State mismatch');
                showError('Invalid state parameter. Please try again.');
                localStorage.removeItem('spotify_token');
                localStorage.removeItem('spotify_auth_state');
                showLogin();
                return;
            }

            if (code) {
                console.log('Authorization code found');
                try {
                    token = await exchangeCodeForToken(code);
                    localStorage.setItem('spotify_token', token);
                    // Remove code from URL to prevent refresh loop
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    if (window.Spotify) {
                        initializePlayer();
                    }
                    showPlayer();
                    loadPlaylists();
                } catch (error) {
                    console.error('Error exchanging code for token:', error);
                    showError('Failed to authenticate. Please try again.');
                    showLogin();
                }
            } else {
                // Check if we have a stored token
                const storedToken = localStorage.getItem('spotify_token');
                if (storedToken) {
                    console.log('Using stored token');
                    token = storedToken;
                    if (window.Spotify) {
                        initializePlayer();
                    }
                    showPlayer();
                    loadPlaylists();
                } else {
                    console.log('No token found, showing login');
                    showLogin();
                }
            }
        };

        // Load user's public playlists
        async function loadPlaylists() {
            try {
                const response = await fetch(`https://api.spotify.com/v1/users/${USER_ID}/playlists`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.items.length === 0) {
                    showError('No public playlists found.');
                    return;
                }
                displayPlaylists(data.items);
            } catch (error) {
                console.error('Error loading playlists:', error);
                showError('Failed to load playlists. Please try again later.');
            }
        }

        // Display playlists in the grid
        function displayPlaylists(playlists) {
            const grid = document.getElementById('playlistGrid');
            grid.innerHTML = '';

            playlists.forEach(playlist => {
                const card = document.createElement('div');
                card.className = 'playlist-card';
                card.innerHTML = `
                    <img src="${playlist.images[0]?.url || 'default-playlist-cover.jpg'}" 
                         alt="${playlist.name}" 
                         class="playlist-cover">
                    <div class="playlist-info">
                        <h3>${playlist.name}</h3>
                        <p>${playlist.tracks.total} tracks</p>
                    </div>
                `;
                card.onclick = () => loadPlaylistTracks(playlist.id);
                grid.appendChild(card);
            });
        }

        // Load tracks for a specific playlist
        async function loadPlaylistTracks(playlistId) {
            try {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.items.length === 0) {
                    showError('No tracks found in this playlist.');
                    return;
                }
                displayTracks(data.items);
            } catch (error) {
                console.error('Error loading tracks:', error);
                showError('Failed to load tracks. Please try again later.');
            }
        }

        // Display tracks in the track list
        function displayTracks(tracks) {
            const container = document.createElement('div');
            container.className = 'track-list';
            
            tracks.forEach(item => {
                const track = item.track;
                const trackElement = document.createElement('div');
                trackElement.className = 'track-item';
                trackElement.innerHTML = `
                    <img src="${track.album.images[2]?.url || 'default-track-cover.jpg'}" 
                         alt="${track.name}">
                    <div class="track-item-info">
                        <h4>${track.name}</h4>
                        <p>${track.artists.map(artist => artist.name).join(', ')}</p>
                    </div>
                    <span class="track-duration">${formatDuration(track.duration_ms)}</span>
                `;
                trackElement.onclick = () => playTrack(track.uri);
                container.appendChild(trackElement);
            });

            // Replace existing track list
            const existingList = document.querySelector('.track-list');
            if (existingList) {
                existingList.remove();
            }
            document.querySelector('.spotify-container').appendChild(container);
        }

        // Format track duration
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Play a specific track
        async function playTrack(uri) {
            try {
                const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: [uri]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error playing track:', error);
                showError('Failed to play track. Please try again.');
            }
        }

        // Player controls
        document.getElementById('playPause').onclick = () => {
            player.togglePlay();
        };

        document.getElementById('prevTrack').onclick = () => {
            player.previousTrack();
        };

        document.getElementById('nextTrack').onclick = () => {
            player.nextTrack();
        };
    </script>
</body>
</html> 